<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Russo Training — Dashboard</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#f5f7fb;margin:0}
  header{background:#0f172a;color:#fff;padding:16px}
  header .sub{opacity:.75;font-size:12px}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;flex:1}
  .kpi{display:flex;gap:12px}
  .kpi .card{min-width:160px}
  h1{font-size:18px;margin:0}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
  .muted{color:#64748b;font-size:12px}
  button{background:#2563eb;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#334155}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .day{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .mono{font-family:ui-monospace,Menlo,monospace}
  input{border:1px solid #e5e7eb;border-radius:8px;padding:8px;width:100%}
  .controls{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>Russo Training — Dashboard</h1>
  <div class="sub">Static UI · FastAPI · Oura (auto-refresh daily via backend)</div>
</header>
<main>
  <div class="controls">
    <label class="muted">Base URL</label>
    <input id="baseUrl" value="https://acr1008.onrender.com" style="max-width:360px">
    <label class="muted">User</label>
    <input id="userId" value="adamrusso1008" style="max-width:200px">
    <button id="btnReload">Reload Dashboard</button>
    <button id="btnRefreshOura" class="secondary">Refresh Oura Now</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="kpi row">
    <div class="card"><div class="muted">Readiness</div><div id="kpi_ready" style="font-size:28px">–</div></div>
    <div class="card"><div class="muted">Sleep (h)</div><div id="kpi_sleep" style="font-size:28px">–</div></div>
    <div class="card"><div class="muted">Resting HR</div><div id="kpi_rhr" style="font-size:28px">–</div></div>
    <div class="card"><div class="muted">HRV</div><div id="kpi_hrv" style="font-size:28px">–</div></div>
    <div class="card"><div class="muted">ACWR</div><div id="kpi_acwr" style="font-size:28px">–</div></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div class="card" style="flex:2">
      <div class="muted">Weekly Plan</div>
      <div id="planDates" class="pill mono"></div>
      <div id="planGrid" class="grid" style="margin-top:8px"></div>
    </div>
    <div class="card" style="flex:1">
      <div class="muted">Coach Notes</div>
      <ul id="notes" style="margin-top:8px"></ul>
    </div>
  </div>
</main>

<script>
const $ = (s)=>document.querySelector(s);
const set = (id,val)=>{ $(id).textContent = val??'–'; }

async function loadDashboard(){
  const base = $('#baseUrl').value.replace(/\/$/,'');
  const user = $('#userId').value;
  $('#status').textContent = 'Loading...';
  try{
    const res = await fetch(`${base}/v1/dashboard?user_id=${encodeURIComponent(user)}`);
    const data = await res.json();

    // Oura KPIs
    const o = data.latest_oura||{};
    set('#kpi_ready', o.readiness_score ?? '–');
    set('#kpi_sleep', o.sleep_hours?.toFixed ? o.sleep_hours.toFixed(1) : o.sleep_hours ?? '–');
    set('#kpi_rhr', o.rhr ?? '–');
    set('#kpi_hrv', o.hrv ?? '–');

    // Plan KPIs & cards
    const p = data.plan || {};
    set('#kpi_acwr', p.acwr ?? '–');
    $('#planDates').textContent = `${p.week_start ?? ''} → ${p.week_end ?? ''}`;
    const grid = $('#planGrid');
    grid.innerHTML = (p.plan||[]).map(d=>{
      const details = Object.entries(d.details||{}).map(([k,v])=>`${k}: ${typeof v==='object'? JSON.stringify(v): v}`).join('\n');
      return `<div class="day"><div class="muted mono">${d.day}</div><div style="font-weight:600">${d.session.replaceAll('_',' ')}</div><pre class="mono" style="white-space:pre-wrap;margin:6px 0 0">${details}</pre></div>`;
    }).join('');

    const notes = $('#notes'); notes.innerHTML = '';
    (p.notes||[]).forEach(n=>{
      const li=document.createElement('li'); li.textContent=n; notes.appendChild(li);
    });

    $('#status').textContent = `Last Oura day: ${o.date ?? 'n/a'}`;
  }catch(e){
    $('#status').textContent = `Error: ${e}`;
  }
}

async function refreshOuraNow(){
  const base = $('#baseUrl').value.replace(/\/$/,'');
  $('#status').textContent = 'Refreshing Oura…';
  try{
    const res = await fetch(`${base}/v1/oura/refresh_daily`, {method:'POST'});
    await res.json();
  }catch(e){}
  await loadDashboard();
}

$('#btnReload').onclick = loadDashboard;
$('#btnRefreshOura').onclick = refreshOuraNow;

// initial load
loadDashboard();
</script>
</body>
</html>
